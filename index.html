<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="scripts/moment-with-locales.min.js"></script>
    <script src="scripts/Chart.bundle.min.js"></script>
    <link href="css/tabulator.min.css" rel="stylesheet" type="text/css"/>
    <script src="scripts/tabulator.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="css/main.css" />
    <title>COVID-19 Time Series</title>
  </head>
 <body class="main-grid">
     <div style="grid-area:header"><h1>COVID-19 Time Series</h1></div>
<!--  <p>Source : COVID-19 data are from John Hopkins CSSE <a href="">github repository</a></p>
  <h2>Summary</h2> -->
  <form id="main_form" style="grid-area:menu" name="panel" class="form-grid">
    <div style="grid-area:source">
    Source:
    <select id="source_sel" name="source">
     <option value="cssejh">CSSE John Hopkins</option>
     <option value="ecdc">European CDC</option>
    </select>
    </div>
<!--
    <div style="grid-area:source">
    <input type="radio" id="data_src_0" name="data_src" value="cssejh">
    <label for="data_src_0">CSSE JH</label>
    <input type="radio" id="data_src_1" name="data_src" value="ecdc">
    <label for="data_src_1">ECDC</label>
    </div> -->
<!--    <label for="vol">Deaths threshold: </label>
    <input type="range" id="vol" name="vol" min="0" max="50"> -->
    <div style="grid-area:feature">
    Data:
    <select id="feature_sel" name="feature">
     <option value="cases">Cases</option>
     <option value="deaths">Deaths</option>
     <option value="recovered">Recovered</option>
    </select>
    </div>
    <div style="grid-area:variant">
    Variant:
    <select id="variant_sel" name="variant">
     <option value="">Raw</option>
     <option value="rpop">Relative</option>
     <option value="growth">Growth</option>
     <option value="perday">Per day</option>
     <option value="perdayrpop">Per day (relative)</option>
    </select>
    </div>
    <div style="grid-area:model; text-align:center">
    Processing:
    <select id="model_sel" name="model">
     <option value="">None</option>
     <option value="smooth5">Smooth (5 days)</option>
     <option value="smooth7">Smooth (7 days)</option>
     <option value="smooth9">Smooth (9 days)</option>
    </select>
    </div>
    <div style="grid-area:param1">
    Parameter:
    <select id="param1_sel" name="param1">
     <option value="">None</option>
     <option value="3">3 days</option>
    </select>
    </div>
   </form>

  <div id="tbl" style="grid-area:main"></div>
  <div style="grid-area:right">
    <canvas class="jchart" data-source="ecdc_confirmed" data-yscale="logarithmic"></canvas>
  </div>

  <form style="grid-area:table-cfg" name="table-cfg" class="table-cfg-grid">
    <div style="grid-area:treeview">
    Treeview:
    <select id="table_treeview_sel" name="table-treeview">
     <option value="1">Yes</option>
     <option value="0">No</option>
    </select>
    </div>
    <div style="grid-area:other">
    Show:
    <select id="table_other_sel" name="table-other">
     <option value="X">All</option>
     <option value="X">Top 30</option>
     <option value="X">Selected</option>
    </select>
    </div>
  </form>
  <form style="grid-area:graph-cfg" name="graph-cfg" class="graph-cfg-grid">
    <div style="grid-area:yscale">
    Yscale:
    <select id="graph_yscale_sel" name="graph-yscale">
     <option value="linear">Linear</option>
     <option value="log">Logarithmic</option>
    </select>
    </div>
    <div style="grid-area:legend">
    Legend:
    <select id="graph_legend_sel" name="graph-legend">
     <option value="0">No</option>
     <option value="1">Yes</option>
    </select>
    </div>
    <div style="grid-area:from">
    From:
    <select id="graph_from_sel" name="graph-from">
     <option value="first">First data</option>
    </select>
    </div>
    <div style="grid-area:to">
    To:
    <select id="graph_to_sel" name="graph-to">
     <option value="last">Last data</option>
    </select>
    </div>
  </form>

  <div style="grid-area:footer; text-align:center">Greetings...</div>
  <script>

  var colors = ["#fad390", "#f8c291", "#6a89cc", "#82ccdd", "#b8e994",
                "#f6b93b", "#e55039", "#4a69bd", "#60a3bc", "#78e08f",
                "#fa983a", "#eb2f06", "#1e3799", "#3c6382", "#38ada9",
                "#e58e26", "#b71540", "#0c2461", "#0a3d62", "#079992",
                ];
  var ncolors = colors.length;
  var charts = {};

  var src_prev = null;
  var current_source = "cssejh";
  var current_dataset = "cssejh_deaths";

  var sources = ['cssejh', 'ecdc'];
  var features = [
  'cssejh_cases',
  'cssejh_deaths',
  'cssejh_cases_rpop',
  'cssejh_deaths_rpop',
  'cssejh_cases_growing',
  'cssejh_deaths_growing',
  'ecdc_cases',
  'ecdc_deaths',
  'ecdc_cases_rpop',
  'ecdc_deaths_rpop',
  'ecdc_cases_growing',
  'ecdc_deaths_growing',
  ];

  // To memorize selected location (and keep them selected between sources)
  //TODO
  var selected_locations = [];

  var tabulator = new Tabulator("#tbl", {
          layout:"fitColumns",
          selectable:true,
          dataTree:true,
//          height:"500px",
          dataTreeStartExpanded:true, //start with an expanded tree
//          initialFilter:[
//            {field:"deaths", type:">=", value:"20"}
//          ],
          columns:[
           {title:'Country', field:'country'},
           //{title:'Population (M)', field:'population', align:'right', formatter:'money', formatterParams:{precision:3}},
           //{title:'Confirmed', field:'confirmed', align:'right'},
           {title:'Deaths', field:'deaths', align:'right'},
           //{title:'Ratio (%)', field:'dc_percent', align:'right', formatter:'money'},
           //{title:'Confirmed / 1M hab', field:'confirmed_rpop', formatter:'money', align:'right'},
           //{title:'Deaths / 1M hab', field:'deaths_rpop', formatter:'money', align:'right'},
           //{title:'Confirmed growing (8j)', field:'confirmed_growing', formatter:'money', align:'right'},
           {title:'Deaths growing (8j)', field:'deaths_growing', formatter:'money', align:'right'},
           //{title:'First case', field:'first_case', formatter:'datetime', align:'right'},
           {formatter:'rowSelection', titleFormatter:'rowSelection', align:'center', headerSort:false, width:16},
           {title:'Col', field:'color', formatter:'color', width:10, headerSort:false},
          ],
          ajaxURL:'data/cssejh_summary.json',
          ajaxResponse:function(url, params, response)
           {
            //url - the URL of the request
            //params - the parameters passed with the request
            //response - the JSON object returned in the body of the response.

            function color_it(array)
             {
              for (var i = 0; i<array.length ;i++)
               {
                array[i]['color'] = colors[array[i]['id'] % ncolors];
                if (array[i]['_children'])
                 {
                  color_it(array[i]['_children']);
                 }
               }
             };

            color_it(response);
            console.log('response:',response.length);
            return response; //return the tableData property of a response json object
           },
        rowSelectionChanged:function(data, rows){
            //rows - array of row components for the selected rows in order of selection
            //data - array of data objects for the selected rows in order of selection
            console.log(rows);
            if (data.length > 0)
             {
            // Update selected_locations array (TODO: Improve efficiency...)
            selected_locations = [];
            for (var r in data)
             {
              selected_locations.push(data[r].id);
             }
            console.log(data.length, selected_locations);

            if (data.length > 0)
             {
              var locations = [];
              for (i in data)
               {
                locations.push(data[i]['country']);
               }
              var dataset = [];
              for (d in datasets[current_dataset])
               {
                if (locations.includes(datasets[current_dataset][d]['label']))
                 {
                dataset.push(datasets[current_dataset][d]);
                 }
               }
              charts['ecdc_confirmed'].data.datasets = dataset;
              charts['ecdc_confirmed'].update();
             }
            else
             {
              this.selectRow(0);
             }
           }
         },
         dataLoaded:function()
          {

           console.log('loaded');
           console.log(selected_locations);
           console.log('length',this.rowManager.rows.length);
//             this.selectRow(2);
           var rows_to_select = [];
           for (var i in tabulator.rowManager.rows)
            {
             //console.log(i, ' id ', this.rowManager.rows[i].data.id);
             //this.selectRow(selected_locations[i]);
             if (selected_locations.includes(this.rowManager.rows[i].data.id))
              {
                rows_to_select.push(this.rowManager.rows[i]);
              }
            }
            console.log(rows_to_select);

               tabulator.selectRow(rows_to_select);
           setTimeout(function(){
               console.log('to:', tabulator.rowManager.rows.length,"Asia");
//               console.log('to:', tabulator.rowManager.rows[2]);
               tabulator.selectRow(tabulator.rowManager.rows[2]);
               }, 1000);
          },
      });

/*
  var src_obj = document.panel.data_src;
  for (var i = 0; i < src_obj.length; i++) {
      src_obj[i].addEventListener('change', function() {
          (src_prev) ? console.log(src_prev.value): null;
          if (this !== src_prev) {
              src_prev = this;
          }
          console.log(this.value)
          console.log("changed.")
          current_source = this.value;
          tabulator.setData('data/'+this.value+'_summary.json');
      });
  }
*/
  // Load summaries data
  var summaries = {};
  var s_requests = [];
  for (var i = 0 ; i < sources.length ; i++)
   {
    s_requests[i] = new XMLHttpRequest();
    var summary_name = sources[i]+'_summary';
    s_requests[i].open('GET', 'data/'+summary_name+'.json');
    s_requests[i].responseType = 'json';
    s_requests[i].send();
    s_requests[i].featname = summary_name;
    s_requests[i].onload = function(request)
     {
      function color_it(array)
       {
        for (var i = 0; i<array.length ;i++)
         {
          array[i]['color'] = colors[array[i]['id'] % ncolors];
          if (array[i]['_children'])
           {
            color_it(array[i]['_children']);
           }
         }
       };
      color_it(request.target.response);
      summaries[request.target.summary_name] = request.target.response;
     }
   }

  // Load features data (datasets)
  var datasets = {};
  var f_requests = [];
  for (var i = 0 ; i < features.length ; i++)
   {
    f_requests[i] = new XMLHttpRequest();
    var featname = features[i];
    f_requests[i].open('GET', 'data/'+featname+'.json');
    f_requests[i].responseType = 'json';
    f_requests[i].send();
    f_requests[i].featname = featname;
    f_requests[i].onload = function(e)
     {
      var data = e.target.response;
      datasets[e.target.featname] = []
      var j = 0;
      for (var key in data) {
        var dataset =
          {
           "label":key,
           "fill":false,
           "borderWidth":1,
           "borderColor":colors[j % ncolors],
            data:[]
          };
        j++;
        //var k=0;
        for (var d in data[key])
         {
          dataset.data.push({x:d,y:data[key][d]});
          //k++;
         }
        datasets[e.target.featname].push(dataset);
       };
     };
   };

   function build_chart(ctx)
    {
   var request = new XMLHttpRequest();
   request.open('GET', 'data/'+ctx.dataset.source+'.json');
   request.responseType = 'json';
   request.send();
   request.onload = function() {
       var data = request.response;
       datasets[ctx.dataset.source] = []
       var j = 0;
       for (var key in data) {
           var dataset =
            {
             "label":key,
             "fill":false,
             "borderWidth":2,
             "borderColor":colors[j % ncolors],
              data:[]};
           j++;
           var i=0;
           for (var d in data[key])
            {
             dataset.data.push({x:d,y:data[key][d]});
             i++;
            }
           datasets[ctx.dataset.source].push(dataset);
         };

   charts[ctx.dataset.source] = new Chart(ctx, {
    type: 'line',
    data: {
        datasets: datasets[ctx.dataset.source]
    },
    options: {
        maintainAspectRatio:false,
        title: {
            display: true,
            text: 'Deaths',
        },
        legend: {
            position:'right',
            },
        scales: {
            yAxes: [{
                type: ctx.dataset.yscale,
                ticks: {
                    //beginAtZero: true,

                }
            }],
            xAxes: [{
                type:'time',
                ticks: {
//                    beginAtZero: true,

                }
            }]
        }
    }
});
       }
    };

  function mainform_update(event)
   {
    console.log("mainform event :");
    mf = document.getElementById("main_form");
    console.log(mf.source_sel.value);
    if (current_source != mf.source_sel.value)
     {
      current_source = mf.source_sel.value;
      tabulator.setData('data/'+current_source+'_summary.json');
     }
    /*  */
    current_dataset = current_source + '_' + mf.feature_sel.value;
    if (mf.variant_sel.value != '')
     {
      current_dataset += '_' + mf.variant_sel.value;
     }
    if (mf.model_sel.value != '')
     {
      current_dataset += '_' + mf.model_sel.value;
     }
    if (mf.param1_sel.value != '')
     {
      current_dataset += '_' + mf.param1_sel.value;
     }
    // Update chart...
    //TODO
    console.log('current_dataset is now :', current_dataset);
   };


 dom_charts = document.getElementsByClassName("jchart");
 for (let i = 0; i < dom_charts.length; i++)
  {
   let ctx = dom_charts[i];
   build_chart(ctx);
  }

  document.getElementById("source_sel").addEventListener('change', mainform_update);
  document.getElementById("feature_sel").addEventListener('change', mainform_update);
  document.getElementById("variant_sel").addEventListener('change', mainform_update);
  document.getElementById("model_sel").addEventListener('change', mainform_update);
  document.getElementById("param1_sel").addEventListener('change', mainform_update);

/*  document.getElementById("show0").addEventListener('click', function(event) {
      console.log('Clicked show !');
      charts['confirmed'].data.datasets[0].hidden = false;
      charts['confirmed'].update();
      });
  document.getElementById("hide0").addEventListener('click', function(event) {
      console.log('Clicked hide !');
      charts['confirmed'].data.datasets[0].hidden = true;
      charts['confirmed'].update();
      });*/

</script>
 </body>
</html>
