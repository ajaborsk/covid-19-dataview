<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="scripts/moment-with-locales.min.js"></script>
    <script src="scripts/Chart.bundle.min.js"></script>
    <link href="css/tabulator.min.css" rel="stylesheet" type="text/css"/>
    <script src="scripts/tabulator.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="css/main.css" />
    <title>COVID-19 Time Series</title>
  </head>
 <body class="main-grid">
     <div style="grid-area:header"><h1>COVID-19 Time Series</h1></div>

  <form id="main_form" style="grid-area:menu" name="panel" class="form-grid">
    <div style="grid-area:source">
    Source:
    <select id="source_sel" name="source" autocomplete="off">
     <option value="cssejh" selected="selected">CSSE John Hopkins</option>
     <option value="ecdc">European CDC</option>
    </select>
    </div>
    <div style="grid-area:feature">
    Data:
    <select id="feature_sel" name="feature">
     <option value="cases">Cases</option>
     <option value="deaths">Deaths</option>
     <option value="recovered">Recovered</option>
    </select>
    </div>
    <div style="grid-area:variant">
    Variant:
    <select id="variant_sel" name="variant">
     <option value="" selected="true">Raw</option>
     <option value="rpop">Relative</option>
     <option value="growing">Growth</option>
     <option value="perday">Per day</option>
     <option value="perdayrpop">Per day (relative)</option>
    </select>
    </div>
    <div style="grid-area:model; text-align:center">
    Processing:
    <select id="model_sel" name="model">
     <option value="">None</option>
     <option value="smooth5">Smooth (5 days)</option>
     <option value="smooth7">Smooth (7 days)</option>
     <option value="smooth9">Smooth (9 days)</option>
    </select>
    </div>
    <div style="grid-area:param1">
    Parameter:
    <select id="param1_sel" name="param1">
     <option value="">None</option>
     <option value="3">3 days</option>
    </select>
    </div>
   </form>

  <div id="tbl" style="grid-area:main"></div>

  <div style="grid-area:right">
    <canvas class="jchart" data-name="main_chart" data-yscale="logarithmic"></canvas>
  </div>

  <form id="table_form" style="grid-area:table-cfg" name="table-cfg" class="table-cfg-grid">
    <div style="grid-area:treeview">
    Treeview:
    <select id="table_treeview_sel" name="table-treeview">
     <option value="1">Yes</option>
     <option value="0">No</option>
    </select>
    </div>
    <div style="grid-area:other">
    Show:
    <select id="table_other_sel" name="table-other">
     <option value="X">All</option>
     <option value="X">Top 30</option>
     <option value="X">Selected</option>
    </select>
    </div>
  </form>

  <form style="grid-area:graph-cfg" id="chart_form" name="char_cfg" class="graph-cfg-grid">
    <div style="grid-area:yscale">
    Yscale:
    <select id="chart_yscale_sel" name="chart_yscale">
     <option value="linear">Linear</option>
     <option value="logarithmic" selected>Logarithmic</option>
    </select>
    </div>
    <div style="grid-area:legend">
    Legend:
    <select id="chart_legend_sel" name="chart_legend">
     <option value="false">No</option>
     <option value="true">Yes</option>
    </select>
    </div>
    <div style="grid-area:from">
    From:
    <select id="graph_from_sel" name="graph_from">
     <option value="first">First data</option>
    </select>
    </div>
    <div style="grid-area:to">
    To:
    <select id="graph_to_sel" name="graph_to">
     <option value="last">Last data</option>
    </select>
    </div>
  </form>

  <div style="grid-area:footer; text-align:center">Greetings...</div>
  <script>

  var colors = ["#fad390", "#f8c291", "#6a89cc", "#82ccdd", "#b8e994",
                "#f6b93b", "#e55039", "#4a69bd", "#60a3bc", "#78e08f",
                "#fa983a", "#eb2f06", "#1e3799", "#3c6382", "#38ada9",
                "#e58e26", "#b71540", "#0c2461", "#0a3d62", "#079992",
                ];
  var ncolors = colors.length;

  var charts = {};
  var datasets = {};

  var settings = {
      source: '-',
      feature: '-',
      variant: '-',
      model: '-',
      param1: '-',
  };

  // To get from globals.json ?
  var sources = ['cssejh', 'ecdc'];
  var features = [
  'cssejh_cases',
  'cssejh_deaths',
  'cssejh_cases_rpop',
  'cssejh_deaths_rpop',
  'cssejh_cases_growing',
  'cssejh_deaths_growing',
  'ecdc_cases',
  'ecdc_deaths',
  'ecdc_cases_rpop',
  'ecdc_deaths_rpop',
  'ecdc_cases_growing',
  'ecdc_deaths_growing',
  ];

  var unloaded = features.length;

  // To memorize selected location (and keep them selected between sources)
  var selected_locations = [];

  var tabulator = new Tabulator("#tbl", {
          layout:"fitColumns",
          selectable:true,
          dataTree:true,
          dataTreeStartExpanded:true, //start with an expanded tree
          initialFilter:[
            {field:"deaths", type:">=", value:"20"}
          ],
          columns:[
           {title:'Country', field:'country'},
           //{title:'Population (M)', field:'population', align:'right', formatter:'money', formatterParams:{precision:3}},
           //{title:'Confirmed', field:'confirmed', align:'right'},
           {title:'Deaths', field:'deaths', align:'right'},
           //{title:'Ratio (%)', field:'dc_percent', align:'right', formatter:'money'},
           //{title:'Confirmed / 1M hab', field:'confirmed_rpop', formatter:'money', align:'right'},
           //{title:'Deaths / 1M hab', field:'deaths_rpop', formatter:'money', align:'right'},
           //{title:'Confirmed growing (8j)', field:'confirmed_growing', formatter:'money', align:'right'},
           {title:'Deaths growing (8j)', field:'deaths_growing', formatter:'money', align:'right'},
           //{title:'First case', field:'first_case', formatter:'datetime', align:'right'},
           {formatter:'rowSelection', titleFormatter:'rowSelection', align:'center', headerSort:false, width:16},
           {title:'Col', field:'color', formatter:'color', width:10, headerSort:false},
          ],
          ajaxURL:'data/cssejh_summary.json',
          ajaxResponse:function(url, params, response)
           {
            //url - the URL of the request
            //params - the parameters passed with the request
            //response - the JSON object returned in the body of the response.

            function color_it(array)
             {
              for (var i = 0; i<array.length ;i++)
               {
                array[i]['color'] = colors[array[i]['id'] % ncolors];
                if (array[i]['_children'])
                 {
                  color_it(array[i]['_children']);
                 }
               }
             };

            color_it(response);
            console.log('response length:',response.length);
            return response; //return the tableData property of a response json object
           },
        rowSelectionChanged:function(data, rows){
            //rows - array of row components for the selected rows in order of selection
            //data - array of data objects for the selected rows in order of selection
            console.log('selectionChanged');
            console.log(rows);
            if (data.length > 0)
             {
            // Update selected_locations array (TODO: Improve efficiency...)
            selected_locations = [];
            for (var r in data)
             {
              selected_locations.push(data[r].id);
             }
            console.log(data.length, selected_locations);
/*
              var locations = [];
              for (i in data)
               {
                locations.push(data[i]['country']);
               }
              var dataset = [];
              for (d in datasets[current_dataset])
               {
                if (locations.includes(datasets[current_dataset][d]['label']))
                 {
                dataset.push(datasets[current_dataset][d]);
                 }
               }
              charts['main_chart'].data.datasets = dataset;
             */ //charts['main_chart'].update();

              page_update({}, new Set(['selection']));
             }
            else
             {
              console.log('select is 0...');
             }
         },
         renderComplete:function(data)
          {
           console.log('tabulator render complete');
           if (this.rowManager.displayRows.length > 0)
            {
             if (selected_locations.length == 0)
              {
               selected_locations.push("World");
              }
             console.log(selected_locations);
//           console.log('length',this.rowManager.rows.length);
             console.log('length',this.rowManager.displayRows[1].length);
//             this.selectRow(2);
             var rows_to_select = [];
             for (var i in tabulator.rowManager.displayRows[1])
              {
             //console.log(i, ' id ', this.rowManager.rows[i].data.id);
             //this.selectRow(selected_locations[i]);
               if (selected_locations.includes(tabulator.rowManager.displayRows[1][i].data.id))
                {
                 rows_to_select.push(tabulator.rowManager.displayRows[1][i]);
                }
              }
             console.log(rows_to_select);

             tabulator.selectRow(rows_to_select);
            }
          },
         });

  // Load summaries data
  /*
  var summaries = {};
  var s_requests = [];
  for (var i = 0 ; i < sources.length ; i++)
   {
    s_requests[i] = new XMLHttpRequest();
    var summary_name = sources[i]+'_summary';
    s_requests[i].open('GET', 'data/'+summary_name+'.json');
    s_requests[i].responseType = 'json';
    s_requests[i].send();
    s_requests[i].featname = summary_name;
    s_requests[i].onload = function(request)
     {
      function color_it(array)
       {
        for (var i = 0; i<array.length ;i++)
         {
          array[i]['color'] = colors[array[i]['id'] % ncolors];
          if (array[i]['_children'])
           {
            color_it(array[i]['_children']);
           }
         }
       };
      color_it(request.target.response);
      summaries[request.target.summary_name] = request.target.response;
     }
   }
*/

  // Load features data (datasets)
  var f_requests = [];
  for (var i = 0 ; i < features.length ; i++)
   {
    f_requests[i] = new XMLHttpRequest();
    var featname = features[i];
    f_requests[i].open('GET', 'data/'+featname+'.json');
    f_requests[i].responseType = 'json';
    f_requests[i].send();
    f_requests[i].featname = featname;
    f_requests[i].onload = function(e)
     {
      var data = e.target.response;
      datasets[e.target.featname] = []
      var j = 0;
      for (var key in data) {
        var dataset =
          {
           "label":key,
           "fill":false,
           "borderWidth":1,
           "borderColor":colors[j % ncolors],
            data:[]
          };
        j++;
        //var k=0;
        for (var d in data[key])
         {
          dataset.data.push({x:d,y:data[key][d]});
          //k++;
         }
        datasets[e.target.featname].push(dataset);
       };
      unloaded--;
      if (unloaded == 0)
       {
        console.log("Everything is loaded : Let's go !");
        //TODO
        page_update();
       }
      else
       {
        //Update loader overlay
        console.log("Still", unloaded, "files to load...");
       }
     };
   };

function build_chart(ctx)
 {
  charts[ctx.dataset.name] = new Chart(ctx,
     {
      type: 'line',
 /*     data:
       {
        datasets: [{}],
       }, */
      options:
       {
        maintainAspectRatio:false,
        title:
         {
          display: true,
          text: 'Deaths',
         },
        legend:
         {
          position:'right',
         },
        scales:
         {
          yAxes: [{
                type: ctx.dataset.yscale,
                ticks: {
                    //beginAtZero: true,
                }
           }],
          xAxes: [{
               type:'time',
               ticks: {
//                   beginAtZero: true,
                },
           }]
         },
        tooltips:
         {
          callbacks:
           {
            label: function(tooltipItem, data)
             {
              var label = data.datasets[tooltipItem.datasetIndex].label || '';

              if (label)
               {
                label += ': ';
               }
              label += Math.round(tooltipItem.value * 100) / 100;
              return label;
             },
            title: function(tooltipItem, data)
             {
              return moment(tooltipItem[0].label).format("MM/DD/YYYY");
             }

           },
         },
       },
     });
  // }
 }

 dom_charts = document.getElementsByClassName("jchart");
 for (let i = 0; i < dom_charts.length; i++)
  {
   let ctx = dom_charts[i];
   build_chart(ctx);
  }


/*
  function mainform_update(event)
   {
    console.log('mainform event :');
    mf = document.getElementById('main_form');
    console.log(mf.source_sel.value);
    if (current_source != mf.source_sel.value)
     {
      current_source = mf.source_sel.value;
      console.log('updating summary...');
      tabulator.setData('data/'+current_source+'_summary.json');
     }

    current_dataset = current_source + '_' + mf.feature_sel.value;
    if (mf.variant_sel.value != '')
     {
      current_dataset += '_' + mf.variant_sel.value;
     }
    if (mf.model_sel.value != '')
     {
      current_dataset += '_' + mf.model_sel.value;
     }
    if (mf.param1_sel.value != '')
     {
      current_dataset += '_' + mf.param1_sel.value;
     }
    // Update chart...
    //TODO
    console.log('current_dataset is now :', current_dataset);
   };

 function chartform_update(event)
  {
   var changed = [];
   cf = document.getElementById('chart_form');
   if (charts['main_chart'].options.scales.yAxes[0].type != cf.chart_yscale.value)
    {
     changed.push('chart_yscale');
    };
   if (charts['main_chart'].options.legend.display != (cf.chart_legend.value == "true"))
    {
     changed.push('chart_legend');
    };
   page_update(changed);
  };

*/
 function page_update(event, changed = new Set())
  {
   console.log('page_update, changed=', changed);
   var mf = document.getElementById('main_form');
   var cf = document.getElementById('chart_form');
   var tf = document.getElementById('table_form');

   if (settings['source'] != mf.source_sel.value)
    {
     settings['source'] = mf.source_sel.value;
     tabulator.setData('data/' + settings['source'] + '_summary.json');
     changed.add('source');
     //chart_datasets_update_done = false;
    }

   if (settings['feature'] != mf.feature_sel.value)
    {
     settings['feature'] = mf.feature_sel.value;
     changed.add('feature');
     //datasets_update_done = false;
    }

   if (settings['variant'] != mf.variant_sel.value)
    {
     settings['variant'] = mf.variant_sel.value;
     changed.add('variant');
     //datasets_update_done = false;
    }

   if (settings['model'] != mf.model_sel.value)
    {
     settings['model'] = mf.model_sel.value;
     changed.add('model');
     //datasets_update_done = false;
    }

   if (settings['param1'] != mf.param1_sel.value)
    {
     settings['param1'] = mf.param1_sel.value;
     changed.add('param1');
     //datasets_update_done = false;
    }

   if ('main_chart' in charts)
    {
     if (charts['main_chart'].options.scales.yAxes[0].type != cf.chart_yscale.value)
      {
       charts['main_chart'].options.scales.yAxes[0].type = cf.chart_yscale.value;
       //chart_update_done = false;
       changed.add('chart_data');
      }

     if (charts['main_chart'].options.legend.display != (cf.chart_legend.value == "true"))
      {
       charts['main_chart'].options.legend.display = (cf.chart_legend.value == "true");
       //chart_update_done = false;
       changed.add('chart_data');
      }
    }

   while  (changed.size != 0)
    {
//     var datasets_update_done = true;
//     var chart_datasets_update_done = true;
//     var chart_options_update_done = true;
//     var chart_update_done = true;

     if (changed.has('source') ||
       changed.has('feature') ||
       changed.has('variant') ||
       changed.has('model') ||
       changed.has('param1'))
     //if (chart_datasets_update_done == false)
      {
       settings['dataset'] = settings['source'] + '_' + settings['feature'];
       if (settings['variant'] != '')
        {
         settings['dataset'] += '_' + settings['variant'];
        }
       if (settings['model'] != '')
        {
         settings['dataset'] += '_' + settings['model'];
        }
       if (settings['param1'] != '')
        {
         settings['dataset'] += '_' + settings['param1'];
        }
       changed.delete('source');
       changed.delete('feature');
       changed.delete('variant');
       changed.delete('model');
       changed.delete('param1');
       changed.add('dataset');
       //chart_update_done = false;
      }
      if (changed.has('selection') || changed.has('dataset'))
      {
       var data = tabulator.getSelectedData();
       var locations = [];
       for (i in data)
        {
         locations.push(data[i]['country']);
        }
       var dataset = [];
       for (var location in datasets[settings['dataset']])
        {
         if (locations.includes(datasets[settings['dataset']][location]['label']))
          {
           dataset.push(datasets[settings['dataset']][location]);
          }
        }
       charts['main_chart'].data.datasets = dataset;
       changed.delete('selection');
       changed.delete('dataset');
       //chart_update_done = false;
       changed.add('chart_data');
      }

     if (changed.has('chart_data'))
      {
       charts['main_chart'].update();
       changed.delete('chart_data');
      }

//     done =
//       chart_datasets_update_done &&
//       chart_options_update_done &&
//       chart_update_done;
    } // while()
  };


  document.getElementById("source_sel").addEventListener('change', page_update);
  document.getElementById("feature_sel").addEventListener('change', page_update);
  document.getElementById("variant_sel").addEventListener('change', page_update);
  document.getElementById("model_sel").addEventListener('change', page_update);
  document.getElementById("param1_sel").addEventListener('change', page_update);

  document.getElementById("chart_yscale_sel").addEventListener('change', page_update);
  document.getElementById("chart_legend_sel").addEventListener('change', page_update);


/*  document.getElementById("show0").addEventListener('click', function(event) {
      console.log('Clicked show !');
      charts['confirmed'].data.datasets[0].hidden = false;
      charts['confirmed'].update();
      });
  document.getElementById("hide0").addEventListener('click', function(event) {
      console.log('Clicked hide !');
      charts['confirmed'].data.datasets[0].hidden = true;
      charts['confirmed'].update();
      });*/

document.onLoad = function()
 {
//  page_update();
 }

</script>
 </body>
</html>
